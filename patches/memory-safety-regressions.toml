[meta]
name = "memory-safety-regressions"
description = "Restore memory throughput defaults, preserve developer-message memory ingestion, and gate debug memory drop behind explicit yes confirmation"
version_range = ">=0.101.0-alpha.1, <0.102.0"
workspace_relative = true

[[patches]]
id = "restore-phase1-memory-throughput"
file = "core/src/memories/mod.rs"

[patches.query]
type = "text"
search = '''
    /// Maximum number of rollout candidates processed per startup pass.
    pub(super) const MAX_ROLLOUTS_PER_STARTUP: usize = 8;
    /// Concurrency cap for startup memory extraction and consolidation scheduling.
    pub(super) const CONCURRENCY_LIMIT: usize = 8;
'''

[patches.operation]
type = "replace"
text = '''
    /// Maximum number of rollout candidates processed per startup pass.
    pub(super) const MAX_ROLLOUTS_PER_STARTUP: usize = 64;
    /// Concurrency cap for startup memory extraction and consolidation scheduling.
    pub(super) const CONCURRENCY_LIMIT: usize = 64;
'''

[[patches]]
id = "restore-phase2-memory-heartbeat"
file = "core/src/memories/mod.rs"

[patches.query]
type = "text"
search = '''
    /// Heartbeat interval (seconds) for phase-2 running jobs.
    pub(super) const JOB_HEARTBEAT_SECONDS: u64 = 90;
'''

[patches.operation]
type = "replace"
text = '''
    /// Heartbeat interval (seconds) for phase-2 running jobs.
    pub(super) const JOB_HEARTBEAT_SECONDS: u64 = 30;
'''

[[patches]]
id = "preserve-developer-message-memory-ingestion"
file = "core/src/rollout/policy.rs"

[patches.query]
type = "text"
search = '''
    match item {
        ResponseItem::Message { role, .. } => role != "developer",
        ResponseItem::LocalShellCall { .. }
'''

[patches.operation]
type = "replace"
text = '''
    match item {
        ResponseItem::Message { .. }
        | ResponseItem::LocalShellCall { .. }
'''

[[patches]]
id = "require-explicit-yes-for-memory-drop"
file = "core/src/codex.rs"

[patches.query]
type = "text"
search = '''
    pub async fn drop_memories(sess: &Arc<Session>, config: &Arc<Config>, sub_id: String) {
        let mut errors = Vec::new();

        if let Some(state_db) = sess.services.state_db.as_deref() {
'''

[patches.operation]
type = "replace"
text = '''
    pub async fn drop_memories(sess: &Arc<Session>, config: &Arc<Config>, sub_id: String) {
        let mut errors = Vec::new();

        let confirmation = std::env::var("CODEX_DEBUG_MEMORY_DROP_CONFIRM").unwrap_or_default();
        if confirmation != "yes" {
            sess.send_event_raw(Event {
                id: sub_id,
                msg: EventMsg::Error(ErrorEvent {
                    message: "Refusing to drop memories without explicit confirmation. Set CODEX_DEBUG_MEMORY_DROP_CONFIRM=yes and retry /debug-m-drop.".to_string(),
                    codex_error_info: Some(CodexErrorInfo::Other),
                }),
            })
            .await;
            return;
        }

        if let Some(state_db) = sess.services.state_db.as_deref() {
'''

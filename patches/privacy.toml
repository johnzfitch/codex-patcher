# =============================================================================
# PRIVACY PATCHES - Comprehensive Privacy Hardening for Codex
# =============================================================================
#
# These patches remove/disable various privacy-impacting features in Codex:
#
# 1. TELEMETRY (Patches 1-5):
#    - Disable Statsig metrics to ab.chatgpt.com
#    - Remove hardcoded API keys and endpoints
#    - Set default metrics exporter to None
#
# 2. GIT REPOSITORY TRACKING (Patches 6-7):
#    - Redact git_origin_url from state DB and rollout metadata
#    - Prevents leaking repository identity (may contain usernames in SSH URLs)
#
# 3. WEB SEARCH (Patch 8):
#    - Disable web search by default (was: Cached/Live based on sandbox)
#    - Prevents search queries from being sent externally
#    - User can still explicitly enable via config if needed
#
# Affected files:
# - codex-rs/otel/src/config.rs: Statsig telemetry removal
# - codex-rs/core/src/config/types.rs: Default metrics exporter
# - codex-rs/state/src/extract.rs: Git origin URL redaction
# - codex-rs/core/src/rollout/metadata.rs: Git origin URL redaction
# - codex-rs/core/src/config/mod.rs: Web search disable
#
# Version: Targets Codex rust-v0.88.0 and later
# =============================================================================

[meta]
name = "privacy-patches"
description = "Comprehensive privacy hardening: disable telemetry, redact git URLs, disable web search"
version_range = ">=0.88.0"
workspace_relative = true

# =============================================================================
# Patch 1: Disable Statsig Resolver
# =============================================================================
# The resolve_exporter function originally hardcoded Statsig API credentials
# and only disabled telemetry in test builds. This patch makes it always
# return OtelExporter::None for Statsig requests.

[[patches]]
id = "disable-statsig-resolver"
file = "otel/src/config.rs"

[patches.query]
type = "ast-grep"
pattern = '''
pub(crate) fn resolve_exporter(exporter: &OtelExporter) -> OtelExporter {
    $$$
}
'''

[patches.operation]
type = "replace"
text = '''
pub(crate) fn resolve_exporter(exporter: &OtelExporter) -> OtelExporter {
    match exporter {
        OtelExporter::Statsig => {
            // PRIVACY PATCH: Always return None to disable Statsig telemetry
            // Original code only disabled in tests, but ran in production
            OtelExporter::None
        }
        _ => exporter.clone(),
    }
}
'''

# =============================================================================
# Patch 2: Remove Statsig Endpoint Constant
# =============================================================================
# Remove the hardcoded Statsig OTLP endpoint URL

[[patches]]
id = "remove-statsig-endpoint"
file = "otel/src/config.rs"

[patches.query]
type = "ast-grep"
pattern = '''
pub(crate) const STATSIG_OTLP_HTTP_ENDPOINT: $TYPE = $VALUE;
'''

[patches.operation]
type = "delete"
insert_comment = "// PRIVACY PATCH: Statsig endpoint removed (was: https://ab.chatgpt.com/otlp/v1/metrics)"

# =============================================================================
# Patch 3: Remove Statsig API Key Header Constant
# =============================================================================

[[patches]]
id = "remove-statsig-header"
file = "otel/src/config.rs"

[patches.query]
type = "ast-grep"
pattern = '''
pub(crate) const STATSIG_API_KEY_HEADER: $TYPE = $VALUE;
'''

[patches.operation]
type = "delete"
insert_comment = "// PRIVACY PATCH: Statsig API key header removed"

# =============================================================================
# Patch 4: Remove Statsig API Key Constant
# =============================================================================
# Remove the hardcoded Statsig API key that was sending metrics to OpenAI

[[patches]]
id = "remove-statsig-api-key"
file = "otel/src/config.rs"

[patches.query]
type = "ast-grep"
pattern = '''
pub(crate) const STATSIG_API_KEY: $TYPE = $VALUE;
'''

[patches.operation]
type = "delete"
insert_comment = "// PRIVACY PATCH: Statsig API key removed (was: client-MkRuleRQBd6qakfnDYqJVR9JuXcY57Ljly3vi5JVUIO)"

# =============================================================================
# Patch 5: Change Default Metrics Exporter (types.rs)
# =============================================================================
# In the Default impl for OtelConfig, change metrics_exporter from Statsig to None

[[patches]]
id = "default-metrics-none-types"
file = "core/src/config/types.rs"

[patches.query]
type = "ast-grep"
pattern = '''
impl Default for OtelConfig {
    fn default() -> Self {
        $$$
    }
}
'''

[patches.operation]
type = "replace"
text = '''
impl Default for OtelConfig {
    fn default() -> Self {
        OtelConfig {
            log_user_prompt: false,
            environment: DEFAULT_OTEL_ENVIRONMENT.to_owned(),
            exporter: OtelExporterKind::None,
            trace_exporter: OtelExporterKind::None,
            metrics_exporter: OtelExporterKind::None, // PRIVACY PATCH: Changed from Statsig
        }
    }
}
'''

# =============================================================================
# Patch 6: Redact git_origin_url from State DB (state/src/extract.rs)
# =============================================================================
# Prevents storing git remote URLs which may contain usernames or identify repos

[[patches]]
id = "redact-git-origin-url-state"
file = "state/src/extract.rs"

[patches.query]
type = "text"
search = '''
    if let Some(git) = meta_line.git.as_ref() {
        metadata.git_sha = git.commit_hash.clone();
        metadata.git_branch = git.branch.clone();
        metadata.git_origin_url = git.repository_url.clone();
    }
'''

[patches.operation]
type = "replace"
text = '''
    if let Some(git) = meta_line.git.as_ref() {
        metadata.git_sha = git.commit_hash.clone();
        metadata.git_branch = git.branch.clone();
        // PRIVACY PATCH: Redact git origin URL to prevent leaking repo identity
        metadata.git_origin_url = None;
    }
'''

# =============================================================================
# Patch 7: Redact git_origin_url from Rollout Metadata (core/src/rollout/metadata.rs)
# =============================================================================

[[patches]]
id = "redact-git-origin-url-rollout"
file = "core/src/rollout/metadata.rs"

[patches.query]
type = "text"
search = '''
    if let Some(git) = session_meta.git.as_ref() {
        builder.git_sha = git.commit_hash.clone();
        builder.git_branch = git.branch.clone();
        builder.git_origin_url = git.repository_url.clone();
    }
'''

[patches.operation]
type = "replace"
text = '''
    if let Some(git) = session_meta.git.as_ref() {
        builder.git_sha = git.commit_hash.clone();
        builder.git_branch = git.branch.clone();
        // PRIVACY PATCH: Redact git origin URL to prevent leaking repo identity
        builder.git_origin_url = None;
    }
'''

# =============================================================================
# Patch 8: Disable Auto Web Search (default to Disabled, user can override)
# =============================================================================
# Prevents automatic web search enablement based on sandbox policy.
# User can still explicitly enable web_search in config.toml if desired.
# For privacy, use Kagi MCP server instead of OpenAI's built-in search.

[[patches]]
id = "disable-auto-web-search"
file = "core/src/config/mod.rs"

[patches.query]
type = "text"
search = '''
pub(crate) fn resolve_web_search_mode_for_turn(
    explicit_mode: Option<WebSearchMode>,
    is_azure_responses_endpoint: bool,
    sandbox_policy: &SandboxPolicy,
) -> WebSearchMode {
    if let Some(mode) = explicit_mode {
        return mode;
    }
    if is_azure_responses_endpoint {
        return WebSearchMode::Disabled;
    }
    if matches!(sandbox_policy, SandboxPolicy::DangerFullAccess) {
        WebSearchMode::Live
    } else {
        WebSearchMode::Cached
    }
}
'''

[patches.operation]
type = "replace"
text = '''
pub(crate) fn resolve_web_search_mode_for_turn(
    explicit_mode: Option<WebSearchMode>,
    _is_azure_responses_endpoint: bool,
    _sandbox_policy: &SandboxPolicy,
) -> WebSearchMode {
    // PRIVACY PATCH: Default to Disabled instead of auto-enabling based on sandbox
    // User can explicitly set web_search = "live" or "cached" in config.toml
    // For privacy-respecting search, use Kagi MCP server instead
    if let Some(mode) = explicit_mode {
        return mode;
    }
    WebSearchMode::Disabled
}
'''
